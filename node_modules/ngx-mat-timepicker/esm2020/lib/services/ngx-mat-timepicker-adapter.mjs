import { NgxMatTimepickerFormat } from "../models/ngx-mat-timepicker-format.enum";
import { NgxMatTimepickerPeriods } from "../models/ngx-mat-timepicker-periods.enum";
//
import { DateTime } from "ts-luxon";
// @dynamic
export class NgxMatTimepickerAdapter {
    /***
     *  Format hour according to time format (12 or 24)
     */
    static formatHour(currentHour, format, period) {
        if (this.isTwentyFour(format)) {
            return currentHour;
        }
        const hour = period === NgxMatTimepickerPeriods.AM ? currentHour : currentHour + 12;
        if (period === NgxMatTimepickerPeriods.AM && hour === 12) {
            return 0;
        }
        else if (period === NgxMatTimepickerPeriods.PM && hour === 24) {
            return 12;
        }
        return hour;
    }
    static formatTime(time, opts) {
        if (!time) {
            return "Invalid Time";
        }
        const parsedTime = this.parseTime(time, opts).setLocale(this.defaultLocale);
        const isTwelve = !this.isTwentyFour(opts.format);
        if (isTwelve) {
            return parsedTime.toLocaleString({
                ...DateTime.TIME_SIMPLE,
                hour12: isTwelve
            }).replace(/\u200E/g, "");
        }
        return parsedTime.toISOTime({
            includeOffset: false,
            suppressMilliseconds: true,
            suppressSeconds: true
        }).replace(/\u200E/g, "");
    }
    static fromDateTimeToString(time, format) {
        return time.reconfigure({
            numberingSystem: this.defaultNumberingSystem,
            locale: this.defaultLocale
        }).toFormat(this.isTwentyFour(format) ? NgxMatTimepickerFormat.TWENTY_FOUR : NgxMatTimepickerFormat.TWELVE);
    }
    static isBetween(time, before, after, unit = "minutes") {
        const innerUnit = unit === "hours" ? unit : void 0;
        return this.isSameOrBefore(time, after, innerUnit) && this.isSameOrAfter(time, before, innerUnit);
    }
    static isSameOrAfter(time, compareWith, unit = "minutes") {
        if (unit === "hours") {
            return time.hour >= compareWith.hour;
        }
        return time.hasSame(compareWith, unit) || time.valueOf() > compareWith.valueOf();
    }
    static isSameOrBefore(time, compareWith, unit = "minutes") {
        if (unit === "hours") {
            return time.hour <= compareWith.hour;
        }
        return time.hasSame(compareWith, unit) || time.valueOf() <= compareWith.valueOf();
    }
    static isTimeAvailable(time, min, max, granularity, minutesGap, format) {
        if (!time) {
            return void 0;
        }
        const convertedTime = this.parseTime(time, { format });
        const minutes = convertedTime.minute;
        if (minutesGap && minutes === minutes && minutes % minutesGap !== 0) {
            throw new Error(`Your minutes - ${minutes} doesn\'t match your minutesGap - ${minutesGap}`);
        }
        const isAfter = (min && !max)
            && this.isSameOrAfter(convertedTime, min, granularity);
        const isBefore = (max && !min)
            && this.isSameOrBefore(convertedTime, max, granularity);
        const between = (min && max)
            && this.isBetween(convertedTime, min, max, granularity);
        const isAvailable = !min && !max;
        return isAfter || isBefore || between || isAvailable;
    }
    static isTwentyFour(format) {
        return format === 24;
    }
    static parseTime(time, opts) {
        const localeOpts = this._getLocaleOptionsByTime(time, opts);
        let timeMask = NgxMatTimepickerFormat.TWENTY_FOUR_SHORT;
        // If there's a space, means we have the meridiem. Way faster than splitting text
        // if (~time.indexOf(" ")) {
        // 09/02/2023 it seems that sometimes the space from the formatter is a nnbsp (Chromium >= 110)
        // which causes the indexOf(" ") to fail: charCode 32, while nbsp is 8239
        if (time.match(/\s/g)) {
            /*
             * We translate the meridiem in simple AM or PM letters (instead of A.M.)
             * because even if we set the locale with NgxMatTimepickerModule.setLocale
             * the default (en-US) will always be used here
             */
            time = time.replace(/\.\s*/g, "");
            timeMask = NgxMatTimepickerFormat.TWELVE_SHORT;
        }
        return DateTime.fromFormat(time.replace(/\s+/g, " "), timeMask, {
            numberingSystem: localeOpts.numberingSystem,
            locale: localeOpts.locale
        });
    }
    static toLocaleTimeString(time, opts = {}) {
        const { format = this.defaultFormat, locale = this.defaultLocale } = opts;
        let hourCycle = "h12";
        let timeMask = NgxMatTimepickerFormat.TWELVE_SHORT;
        if (this.isTwentyFour(format)) {
            hourCycle = "h23";
            timeMask = NgxMatTimepickerFormat.TWENTY_FOUR_SHORT;
        }
        return DateTime.fromFormat(time, timeMask).reconfigure({
            locale,
            numberingSystem: opts.numberingSystem,
            defaultToEN: opts.defaultToEN,
            outputCalendar: opts.outputCalendar
        }).toLocaleString({
            ...DateTime.TIME_SIMPLE,
            hourCycle
        });
    }
    /**
     *
     * @param time
     * @param opts
     * @private
     */
    static _getLocaleOptionsByTime(time, opts) {
        const { numberingSystem, locale } = DateTime.now().reconfigure({
            locale: opts.locale,
            numberingSystem: opts.numberingSystem,
            outputCalendar: opts.outputCalendar,
            defaultToEN: opts.defaultToEN
        }).resolvedLocaleOptions();
        return isNaN(parseInt(time, 10)) ? {
            numberingSystem: numberingSystem,
            locale
        } : {
            numberingSystem: this.defaultNumberingSystem,
            locale: this.defaultLocale
        };
    }
}
NgxMatTimepickerAdapter.defaultFormat = 12;
NgxMatTimepickerAdapter.defaultLocale = "en-US";
NgxMatTimepickerAdapter.defaultNumberingSystem = "latn";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW1hdC10aW1lcGlja2VyLWFkYXB0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtbWF0LXRpbWVwaWNrZXIvc3JjL2xpYi9zZXJ2aWNlcy9uZ3gtbWF0LXRpbWVwaWNrZXItYWRhcHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSwwQ0FBMEMsQ0FBQztBQUVoRixPQUFPLEVBQUMsdUJBQXVCLEVBQUMsTUFBTSwyQ0FBMkMsQ0FBQztBQUVsRixFQUFFO0FBQ0YsT0FBTyxFQUFDLFFBQVEsRUFBaUMsTUFBTSxVQUFVLENBQUM7QUFFbEUsV0FBVztBQUNYLE1BQU0sT0FBTyx1QkFBdUI7SUFNaEM7O09BRUc7SUFDSCxNQUFNLENBQUMsVUFBVSxDQUFDLFdBQW1CLEVBQUUsTUFBa0MsRUFBRSxNQUErQjtRQUN0RyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDM0IsT0FBTyxXQUFXLENBQUM7U0FDdEI7UUFDRCxNQUFNLElBQUksR0FBRyxNQUFNLEtBQUssdUJBQXVCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFFcEYsSUFBSSxNQUFNLEtBQUssdUJBQXVCLENBQUMsRUFBRSxJQUFJLElBQUksS0FBSyxFQUFFLEVBQUU7WUFDdEQsT0FBTyxDQUFDLENBQUM7U0FDWjthQUNJLElBQUksTUFBTSxLQUFLLHVCQUF1QixDQUFDLEVBQUUsSUFBSSxJQUFJLEtBQUssRUFBRSxFQUFFO1lBQzNELE9BQU8sRUFBRSxDQUFDO1NBQ2I7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFZLEVBQUUsSUFBNkI7UUFDekQsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNQLE9BQU8sY0FBYyxD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VztZQUN2QixTQUFTO1NBQ1osQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssTUFBTSxDQUFDLHVCQUF1QixDQUFDLElBQVksRUFBRSxJQUE2QjtRQUM5RSxNQUFNLEVBQUMsZUFBZSxFQUFFLE1BQU0sRUFBQyxHQUFHLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUM7WUFDekQsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO1lBQ25CLGVBQWUsRUFBRSxJQUFJLENBQUMsZUFBZTtZQUNyQyxjQUFjLEVBQUUsSUFBSSxDQUFDLGNBQWM7WUFDbkMsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO1NBQ2hDLENBQUMsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBRTNCLE9BQU8sS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0IsZUFBZSxFQUFFLGVBQWtDO1lBQ25ELE1BQU07U0FDVCxDQUFDLENBQUMsQ0FBQztZQUNBLGVBQWUsRUFBRSxJQUFJLENBQUMsc0JBQXNCO1lBQzVDLE1BQU0sRUFBRSxJQUFJLENBQUMsYUFBYTtTQUM3QixDQUFDO0lBQ04sQ0FBQzs7QUF4S00scUNBQWEsR0FBK0IsRUFBRSxDQUFDO0FBQy9DLHFDQUFhLEdBQVcsT0FBTyxDQUFDO0FBQ2hDLDhDQUFzQixHQUFvQixNQUFNLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge05neE1hdFRpbWVwaWNrZXJGb3JtYXR9IGZyb20gXCIuLi9tb2RlbHMvbmd4LW1hdC10aW1lcGlja2VyLWZvcm1hdC5lbnVtXCI7XHJcbmltcG9ydCB7Tmd4TWF0VGltZXBpY2tlckZvcm1hdFR5cGV9IGZyb20gXCIuLi9tb2RlbHMvbmd4LW1hdC10aW1lcGlja2VyLWZvcm1hdC50eXBlXCI7XHJcbmltcG9ydCB7Tmd4TWF0VGltZXBpY2tlclBlcmlvZHN9IGZyb20gXCIuLi9tb2RlbHMvbmd4LW1hdC10aW1lcGlja2VyLXBlcmlvZHMuZW51bVwiO1xyXG5pbXBvcnQge05neE1hdFRpbWVwaWNrZXJPcHRpb25zfSBmcm9tIFwiLi4vbW9kZWxzL25neC1tYXQtdGltZXBpY2tlci1vcHRpb25zLmludGVyZmFjZVwiO1xyXG4vL1xyXG5pbXBvcnQge0RhdGVUaW1lLCBMb2NhbGVPcHRpb25zLCBOdW1iZXJpbmdTeXN0ZW19IGZyb20gXCJ0cy1sdXhvblwiO1xyXG5cclxuLy8gQGR5bmFtaWNcclxuZXhwb3J0IGNsYXNzIE5neE1hdFRpbWVwaWNrZXJBZGFwdGVyIHtcclxuXHJcbiAgICBzdGF0aWMgZGVmYXVsdEZvcm1hdDogTmd4TWF0VGltZXBpY2tlckZvcm1hdFR5cGUgPSAxMjtcclxuICAgIHN0YXRpYyBkZWZhdWx0TG9jYWxlOiBzdHJpbmcgPSBcImVuLVVTXCI7XHJcbiAgICBzdGF0aWMgZGVmYXVsdE51bWJlcmluZ1N5c3RlbTogTnVtYmVyaW5nU3lzdGVtID0gXCJsYXRuXCI7XHJcblxyXG4gICAgLyoqKlxyXG4gICAgICogIEZvcm1hdCBob3VyIGFjY29yZGluZyB0byB0aW1lIGZvcm1hdCAoMTIgb3IgMjQpXHJcbiAgICAgKi9cclxuICAgIHN0YXRpYyBmb3JtYXRIb3VyKGN1cnJlbnRIb3VyOiBudW1iZXIsIGZvcm1hdDogTmd4TWF0VGltZXBpY2tlckZvcm1hdFR5cGUsIHBlcmlvZDogTmd4TWF0VGltZXBpY2tlclBlcmlvZHMpOiBudW1iZXIge1xyXG4gICAgICAgIGlmICh0aGlzLmlzVHdlbnR5Rm91cihmb3JtYXQpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjdXJyZW50SG91cjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgaG91ciA9IHBlcmlvZCA9PT0gTmd4TWF0VGltZXBpY2tlclBlcmlvZHMuQU0gPyBjdXJyZW50SG91ciA6IGN1cnJlbnRIb3VyICsgMTI7XHJcblxyXG4gICAgICAgIGlmIChwZXJpb2QgPT09IE5neE1hdFRpbWVwaWNrZXJQZXJpb2RzLkFNICYmIGhvdXIgPT09IDEyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChwZXJpb2QgPT09IE5neE1hdFRpbWVwaWNrZXJQZXJpb2RzLlBNICYmIGhvdXIgPT09IDI0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiAxMjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBob3VyO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBmb3JtYXRUaW1lKHRpbWU6IHN0cmluZywgb3B0czogTmd4TWF0VGltZXBpY2tlck9wdGlvbnMpOiBzdHJpbmcge1xyXG4gICAgICAgIGlmICghdGltZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gXCJJbnZhbGlkIFRpbWVcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGFyc2VkVGltZSA9IHRoaXMucGFyc2VUaW1lKHRpbWUsIG9wdHMpLnNldExvY2FsZSh0aGlzLmRlZmF1bHRMb2NhbGUpO1xyXG4gICAgICAgIGNvbnN0IGlzVHdlbHZlID0gIXRoaXMuaXNUd2VudHlGb3VyKG9wdHMuZm9ybWF0IGFzIE5neE1hdFRpbWVwaWNrZXJGb3JtYXRUeXBlKTtcclxuICAgICAgICBpZiAoaXNUd2VsdmUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHBhcnNlZFRpbWUudG9Mb2NhbGVTdHJpbmcoe1xyXG4gICAgICAgICAgICAgICAgLi4uRGF0ZVRpbWUuVElNRV9TSU1QTEUsXHJcbiAgICAgICAgICAgICAgICBob3VyMTI6IGlzVHdlbHZlXHJcbiAgICAgICAgICAgIH0pLnJlcGxhY2UoL1xcdTIwMEUvZywgXCJcIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcGFyc2VkVGltZS50b0lTT1RpbWUoe1xyXG4gICAgICAgICAgICBpbmNsdWRlT2Zmc2V0OiBmYWxzZSxcclxuICAgICAgICAgICAgc3VwcHJlc3NNaWxsaXNlY29uZHM6IHRydWUsXHJcbiAgICAgICAgICAgIHN1cHByZXNzU2Vjb25kczogdHJ1ZVxyXG4gICAgICAgIH0pLnJlcGxhY2UoL1xcdTIwMEUvZywgXCJcIik7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGZyb21EYXRlVGltZVRvU3RyaW5nKHRpbWU6IERhdGVUaW1lLCBmb3JtYXQ6IE5neE1hdFRpbWVwaWNrZXJGb3JtYXRUeXBlKTogc3RyaW5nIHtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRpbWUucmVjb25maWd1cmUoe1xyXG4gICAgICAgICAgICBudW1iZXJpbmdTeXN0ZW06IHRoaXMuZGVmYXVsdE51bWJlcmluZ1N5c3RlbSxcclxuICAgICAgICAgICAgbG9jYWxlOiB0aGlzLmRlZmF1bHRMb2NhbGVcclxuICAgICAgICB9KS50b0Zvcm1hdCh0aGlzLmlzVHdlbnR5Rm91cihmb3JtYXQpID8gTmd4TWF0VGltZXBpY2tlckZvcm1hdC5UV0VOVFlfRk9VUiA6IE5neE1hdFRpbWVwaWNrZXJGb3JtYXQuVFdFTFZFKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgaXNCZXR3ZWVuKHRpbWU6IERhdGVUaW1lLCBiZWZvcmU6IERhdGVUaW1lLCBhZnRlcjogRGF0ZVRpbWUsIHVuaXQ6IFwiaG91cnNcIiB8IFwibWludXRlc1wiID0gXCJtaW51dGVzXCIpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCBpbm5lclVuaXQgPSB1bml0ID09PSBcImhvdXJzXCIgPyB1bml0IDogdm9pZCAwO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5pc1NhbWVPckJlZm9yZSh0aW1lLCBhZnRlciwgaW5uZXJVbml0KSAmJiB0aGlzLmlzU2FtZU9yQWZ0ZXIodGltZSwgYmVmb3JlLCBpbm5lclVuaXQpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBpc1NhbWVPckFmdGVyKHRpbWU6IERhdGVUaW1lLCBjb21wYXJlV2l0aDogRGF0ZVRpbWUsIHVuaXQ6IFwiaG91cnNcIiB8IFwibWludXRlc1wiID0gXCJtaW51dGVzXCIpOiBib29sZWFuIHtcclxuICAgICAgICBpZiAodW5pdCA9PT0gXCJob3Vyc1wiKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aW1lLmhvdXIgPj0gY29tcGFyZVdpdGguaG91cjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aW1lLmhhc1NhbWUoY29tcGFyZVdpdGgsIHVuaXQpIHx8IHRpbWUudmFsdWVPZigpID4gY29tcGFyZVdpdGgudmFsdWVPZigpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBpc1NhbWVPckJlZm9yZSh0aW1lOiBEYXRlVGltZSwgY29tcGFyZVdpdGg6IERhdGVUaW1lLCB1bml0OiBcImhvdXJzXCIgfCBcIm1pbnV0ZXNcIiA9IFwibWludXRlc1wiKTogYm9vbGVhbiB7XHJcbiAgICAgICAgaWYgKHVuaXQgPT09IFwiaG91cnNcIikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGltZS5ob3VyIDw9IGNvbXBhcmVXaXRoLmhvdXI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGltZS5oYXNTYW1lKGNvbXBhcmVXaXRoLCB1bml0KSB8fCB0aW1lLnZhbHVlT2YoKSA8PSBjb21wYXJlV2l0aC52YWx1ZU9mKCk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGlzVGltZUF2YWlsYWJsZSh0aW1lOiBzdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbj86IERhdGVUaW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBtYXg/OiBEYXRlVGltZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhbnVsYXJpdHk/OiBcImhvdXJzXCIgfCBcIm1pbnV0ZXNcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgbWludXRlc0dhcD86IG51bWJlciB8IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdD86IG51bWJlcik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICghdGltZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdm9pZCAwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY29udmVydGVkVGltZSA9IHRoaXMucGFyc2VUaW1lKHRpbWUsIHtmb3JtYXR9KTtcclxuICAgICAgICBjb25zdCBtaW51dGVzID0gY29udmVydGVkVGltZS5taW51dGU7XHJcblxyXG4gICAgICAgIGlmIChtaW51dGVzR2FwICYmIG1pbnV0ZXMgPT09IG1pbnV0ZXMgJiYgbWludXRlcyAlIG1pbnV0ZXNHYXAgIT09IDApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBZb3VyIG1pbnV0ZXMgLSAke21pbnV0ZXN9IGRvZXNuXFwndCBtYXRjaCB5b3VyIG1pbnV0ZXNHYXAgLSAke21pbnV0ZXNHYXB9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGlzQWZ0ZXIgPSAobWluICYmICFtYXgpXHJcbiAgICAgICAgICAgICYmIHRoaXMuaXNTYW1lT3JBZnRlcihjb252ZXJ0ZWRUaW1lLCBtaW4sIGdyYW51bGFyaXR5KTtcclxuICAgICAgICBjb25zdCBpc0JlZm9yZSA9IChtYXggJiYgIW1pbilcclxuICAgICAgICAgICAgJiYgdGhpcy5pc1NhbWVPckJlZm9yZShjb252ZXJ0ZWRUaW1lLCBtYXgsIGdyYW51bGFyaXR5KTtcclxuICAgICAgICBjb25zdCBiZXR3ZWVuID0gKG1pbiAmJiBtYXgpXHJcbiAgICAgICAgICAgICYmIHRoaXMuaXNCZXR3ZWVuKGNvbnZlcnRlZFRpbWUsIG1pbiwgbWF4LCBncmFudWxhcml0eSk7XHJcbiAgICAgICAgY29uc3QgaXNBdmFpbGFibGUgPSAhbWluICYmICFtYXg7XHJcblxyXG4gICAgICAgIHJldHVybiBpc0FmdGVyIHx8IGlzQmVmb3JlIHx8IGJldHdlZW4gfHwgaXNBdmFpbGFibGU7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGlzVHdlbnR5Rm91cihmb3JtYXQ6IE5neE1hdFRpbWVwaWNrZXJGb3JtYXRUeXBlKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIGZvcm1hdCA9PT0gMjQ7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIHBhcnNlVGltZSh0aW1lOiBzdHJpbmcsIG9wdHM6IE5neE1hdFRpbWVwaWNrZXJPcHRpb25zKTogRGF0ZVRpbWUge1xyXG4gICAgICAgIGNvbnN0IGxvY2FsZU9wdHMgPSB0aGlzLl9nZXRMb2NhbGVPcHRpb25zQnlUaW1lKHRpbWUsIG9wdHMpO1xyXG4gICAgICAgIGxldCB0aW1lTWFzayA9IE5neE1hdFRpbWVwaWNrZXJGb3JtYXQuVFdFTlRZX0ZPVVJfU0hPUlQ7XHJcbiAgICAgICAgLy8gSWYgdGhlcmUncyBhIHNwYWNlLCBtZWFucyB3ZSBoYXZlIHRoZSBtZXJpZGllbS4gV2F5IGZhc3RlciB0aGFuIHNwbGl0dGluZyB0ZXh0XHJcbiAgICAgICAgLy8gaWYgKH50aW1lLmluZGV4T2YoXCIgXCIpKSB7XHJcbiAgICAgICAgLy8gMDkvMDIvMjAyMyBpdCBzZWVtcyB0aGF0IHNvbWV0aW1lcyB0aGUgc3BhY2UgZnJvbSB0aGUgZm9ybWF0dGVyIGlzIGEgbm5ic3AgKENocm9taXVtID49IDExMClcclxuICAgICAgICAvLyB3aGljaCBjYXVzZXMgdGhlIGluZGV4T2YoXCIgXCIpIHRvIGZhaWw6IGNoYXJDb2RlIDMyLCB3aGlsZSBuYnNwIGlzIDgyMzlcclxuICAgICAgICBpZiAodGltZS5tYXRjaCgvXFxzL2cpKSB7XHJcbiAgICAgICAgICAgIC8qXHJcbiAgICAgICAgICAgICAqIFdlIHRyYW5zbGF0ZSB0aGUgbWVyaWRpZW0gaW4gc2ltcGxlIEFNIG9yIFBNIGxldHRlcnMgKGluc3RlYWQgb2YgQS5NLilcclxuICAgICAgICAgICAgICogYmVjYXVzZSBldmVuIGlmIHdlIHNldCB0aGUgbG9jYWxlIHdpdGggTmd4TWF0VGltZXBpY2tlck1vZHVsZS5zZXRMb2NhbGVcclxuICAgICAgICAgICAgICogdGhlIGRlZmF1bHQgKGVuLVVTKSB3aWxsIGFsd2F5cyBiZSB1c2VkIGhlcmVcclxuICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgIHRpbWUgPSB0aW1lLnJlcGxhY2UoL1xcLlxccyovZywgXCJcIik7XHJcbiAgICAgICAgICAgIHRpbWVNYXNrID0gTmd4TWF0VGltZXBpY2tlckZvcm1hdC5UV0VMVkVfU0hPUlQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gRGF0ZVRpbWUuZnJvbUZvcm1hdCh0aW1lLnJlcGxhY2UoL1xccysvZywgXCIgXCIpLCB0aW1lTWFzaywge1xyXG4gICAgICAgICAgICBudW1iZXJpbmdTeXN0ZW06IGxvY2FsZU9wdHMubnVtYmVyaW5nU3lzdGVtLFxyXG4gICAgICAgICAgICBsb2NhbGU6IGxvY2FsZU9wdHMubG9jYWxlXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIHRvTG9jYWxlVGltZVN0cmluZyh0aW1lOiBzdHJpbmcsIG9wdHM6IE5neE1hdFRpbWVwaWNrZXJPcHRpb25zID0ge30pOiBzdHJpbmcge1xyXG4gICAgICAgIGNvbnN0IHtmb3JtYXQgPSB0aGlzLmRlZmF1bHRGb3JtYXQsIGxvY2FsZSA9IHRoaXMuZGVmYXVsdExvY2FsZX0gPSBvcHRzO1xyXG4gICAgICAgIGxldCBob3VyQ3ljbGU6IFwiaDEyXCIgfCBcImgyM1wiID0gXCJoMTJcIjtcclxuICAgICAgICBsZXQgdGltZU1hc2sgPSBOZ3hNYXRUaW1lcGlja2VyRm9ybWF0LlRXRUxWRV9TSE9SVDtcclxuICAgICAgICBpZiAodGhpcy5pc1R3ZW50eUZvdXIoZm9ybWF0IGFzIE5neE1hdFRpbWVwaWNrZXJGb3JtYXRUeXBlKSkge1xyXG4gICAgICAgICAgICBob3VyQ3ljbGUgPSBcImgyM1wiO1xyXG4gICAgICAgICAgICB0aW1lTWFzayA9IE5neE1hdFRpbWVwaWNrZXJGb3JtYXQuVFdFTlRZX0ZPVVJfU0hPUlQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gRGF0ZVRpbWUuZnJvbUZvcm1hdCh0aW1lLCB0aW1lTWFzaykucmVjb25maWd1cmUoe1xyXG4gICAgICAgICAgICBsb2NhbGUsXHJcbiAgICAgICAgICAgIG51bWJlcmluZ1N5c3RlbTogb3B0cy5udW1iZXJpbmdTeXN0ZW0sXHJcbiAgICAgICAgICAgIGRlZmF1bHRUb0VOOiBvcHRzLmRlZmF1bHRUb0VOLFxyXG4gICAgICAgICAgICBvdXRwdXRDYWxlbmRhcjogb3B0cy5vdXRwdXRDYWxlbmRhclxyXG4gICAgICAgIH0pLnRvTG9jYWxlU3RyaW5nKHtcclxuICAgICAgICAgICAgLi4uRGF0ZVRpbWUuVElNRV9TSU1QTEUsXHJcbiAgICAgICAgICAgIGhvdXJDeWNsZVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSB0aW1lXHJcbiAgICAgKiBAcGFyYW0gb3B0c1xyXG4gICAgICogQHByaXZhdGVcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldExvY2FsZU9wdGlvbnNCeVRpbWUodGltZTogc3RyaW5nLCBvcHRzOiBOZ3hNYXRUaW1lcGlja2VyT3B0aW9ucyk6IExvY2FsZU9wdGlvbnMge1xyXG4gICAgICAgIGNvbnN0IHtudW1iZXJpbmdTeXN0ZW0sIGxvY2FsZX0gPSBEYXRlVGltZS5ub3coKS5yZWNvbmZpZ3VyZSh7XHJcbiAgICAgICAgICAgIGxvY2FsZTogb3B0cy5sb2NhbGUsXHJcbiAgICAgICAgICAgIG51bWJlcmluZ1N5c3RlbTogb3B0cy5udW1iZXJpbmdTeXN0ZW0sXHJcbiAgICAgICAgICAgIG91dHB1dENhbGVuZGFyOiBvcHRzLm91dHB1dENhbGVuZGFyLFxyXG4gICAgICAgICAgICBkZWZhdWx0VG9FTjogb3B0cy5kZWZhdWx0VG9FTlxyXG4gICAgICAgIH0pLnJlc29sdmVkTG9jYWxlT3B0aW9ucygpO1xyXG5cclxuICAgICAgICByZXR1cm4gaXNOYU4ocGFyc2VJbnQodGltZSwgMTApKSA/IHtcclxuICAgICAgICAgICAgbnVtYmVyaW5nU3lzdGVtOiBudW1iZXJpbmdTeXN0ZW0gYXMgTnVtYmVyaW5nU3lzdGVtLFxyXG4gICAgICAgICAgICBsb2NhbGVcclxuICAgICAgICB9IDoge1xyXG4gICAgICAgICAgICBudW1iZXJpbmdTeXN0ZW06IHRoaXMuZGVmYXVsdE51bWJlcmluZ1N5c3RlbSxcclxuICAgICAgICAgICAgbG9jYWxlOiB0aGlzLmRlZmF1bHRMb2NhbGVcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcbiJdfQ==