import { Directive, HostListener, Inject, Input } from "@angular/core";
import { NgxMatTimepickerAdapter } from "../services/ngx-mat-timepicker-adapter";
//
import { NgxMatTimepickerUnits } from "../models/ngx-mat-timepicker-units.enum";
import { NGX_MAT_TIMEPICKER_CONFIG } from "../tokens/ngx-mat-timepicker-config.token";
//
import { Subject } from "rxjs";
import { shareReplay, takeUntil } from "rxjs/operators";
import * as i0 from "@angular/core";
import * as i1 from "../services/ngx-mat-timepicker.service";
import * as i2 from "../services/ngx-mat-timepicker-event.service";
import * as i3 from "../services/ngx-mat-timepicker-locale.service";
export class NgxMatTimepickerBaseDirective {
    constructor(_timepickerSrv, _eventSrv, _timepickerLocaleSrv, data) {
        this._timepickerSrv = _timepickerSrv;
        this._eventSrv = _eventSrv;
        this._timepickerLocaleSrv = _timepickerLocaleSrv;
        this.data = data;
        this.activeTimeUnit = NgxMatTimepickerUnits.HOUR;
        this.timeUnit = NgxMatTimepickerUnits;
        this._color = "primary";
        this._subsCtrl$ = new Subject();
        this.color = data.color;
        this.defaultTime = data.defaultTime;
    }
    set color(newValue) {
        this._color = newValue;
    }
    get color() {
        return this._color;
    }
    get defaultTime() {
        return this._defaultTime;
    }
    set defaultTime(time) {
        this._defaultTime = time;
        this._setDefaultTime(time);
    }
    get _locale() {
        return this._timepickerLocaleSrv.locale;
    }
    changePeriod(period) {
        this._timepickerSrv.period = period;
        this._onTimeChange();
    }
    changeTimeUnit(unit) {
        this.activeTimeUnit = unit;
    }
    close() {
        this.data.timepickerBaseRef.close();
    }
    ngOnDestroy() {
        this._subsCtrl$.next();
        this._subsCtrl$.complete();
    }
    ngOnInit() {
        this._defineTime();
        this.selectedHour = this._timepickerSrv.selectedHour
            .pipe(shareReplay({ bufferSize: 1, refCount: true }));
        this.selectedMinute = this._timepickerSrv.selectedMinute
            .pipe(shareReplay({ bufferSize: 1, refCount: true }));
        this.selectedPeriod = this._timepickerSrv.selectedPeriod
            .pipe(shareReplay({ bufferSize: 1, refCount: true }));
        this.data.timepickerBaseRef.timeUpdated.pipe(takeUntil(this._subsCtrl$))
            .subscribe(this._setDefaultTime.bind(this));
    }
    onHourChange(hour) {
        this._timepickerSrv.hour = hour;
        this._onTimeChange();
    }
    onHourSelected(hour) {
        if (!this.data.hoursOnly) {
            this.changeTimeUnit(NgxMatTimepickerUnits.MINUTE);
        }
        this.data.timepickerBaseRef.hourSelected.next(hour);
    }
    onKeydown(e) {
        this._eventSrv.dispatchEvent(e);
        e.stopPropagation();
    }
    onMinuteChange(minute) {
        this._timepickerSrv.minute = minute;
        this._onTimeChange();
    }
    setTime() {
        this.data.timepickerBaseRef.timeSet.emit(this._timepickerSrv.getFullTime(this.data.format));
        this.close();
    }
    _defineTime() {
        const minTime = this.data.minTime;
        if (minTime && (!this.data.time && !this.data.defaultTime)) {
            const time = NgxMatTimepickerAdapter.fromDateTimeToString(minTime, this.data.format);
            this._setDefaultTime(time);
        }
    }
    _onTimeChange() {
        const time = NgxMatTimepickerAdapter.toLocaleTimeString(this._timepickerSrv.getFullTime(this.data.format), {
            locale: this._locale,
            format: this.data.format
        });
        this.data.timepickerBaseRef.timeChanged.emit(time);
    }
    _setDefaultTime(time) {
        this._timepickerSrv.setDefaultTimeIfAvailable(time, this.data.minTime, this.data.maxTime, this.data.format, this.data.minutesGap);
    }
}
NgxMatTimepickerBaseDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.1", ngImport: i0, type: NgxMatTimepickerBaseDirective, deps: [{ token: i1.NgxMatTimepickerService }, { token: i2.NgxMatTimepickerEventService }, { token: i3.NgxMatTimepickerLocaleService }, { token: NGX_MAT_TIMEPICKER_CONFIG }], target: i0.ɵɵFactoryTarget.Directive });
NgxMatTimepickerBaseDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "15.0.1", type: NgxMatTimepickerBaseDirective, selector: "[ngxMatTimepickerBase]", inputs: { color: "color", defaultTime: "defaultTime" }, host: { listeners: { "keydown": "onKeydown($event)" } }, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.1", ngImport: i0, type: NgxMatTimepickerBaseDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: "[ngxMatTimepickerBase]"
                }]
        }], ctorParameters: function () { return [{ type: i1.NgxMatTimepickerService }, { type: i2.NgxMatTimepickerEventService }, { type: i3.NgxMatTimepickerLocaleService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [NGX_MAT_TIMEPICKER_CONFIG]
                }] }]; }, propDecorators: { color: [{
                type: Input
            }], defaultTime: [{
                type: Input
            }], onKeydown: [{
                type: HostListener,
                args: ["keydown", ["$event"]]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW1hdC10aW1lcGlja2VyLWJhc2UuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LW1hdC10aW1lcGlja2VyL3NyYy9saWIvZGlyZWN0aXZlcy9uZ3gtbWF0LXRpbWVwaWNrZXItYmFzZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBb0IsTUFBTSxlQUFlLENBQUM7QUFNeEYsT0FBTyxFQUFDLHVCQUF1QixFQUFDLE1BQU0sd0NBQXdDLENBQUM7QUFDL0UsRUFBRTtBQUNGLE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLHlDQUF5QyxDQUFDO0FBSTlFLE9BQU8sRUFBQyx5QkFBeUIsRUFBQyxNQUFNLDJDQUEyQyxDQUFDO0FBQ3BGLEVBQUU7QUFDRixPQUFPLEVBQWEsT0FBTyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3pDLE9BQU8sRUFBQyxXQUFXLEVBQUUsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7Ozs7O0FBS3RELE1BQU0sT0FBTyw2QkFBNkI7SUFtQ3RDLFlBQXNCLGNBQXVDLEVBQ3ZDLFNBQXVDLEVBQ3ZDLG9CQUFtRCxFQUNuQixJQUE0QjtRQUg1RCxtQkFBYyxHQUFkLGNBQWMsQ0FBeUI7UUFDdkMsY0FBUyxHQUFULFNBQVMsQ0FBOEI7UUFDdkMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUErQjtRQUNuQixTQUFJLEdBQUosSUFBSSxDQUF3QjtRQWJsRixtQkFBYyxHQUEwQixxQkFBcUIsQ0FBQyxJQUFJLENBQUM7UUFJbkUsYUFBUSxHQUFpQyxxQkFBcUIsQ0FBQztRQUVyRCxXQUFNLEdBQWlCLFNBQVMsQ0FBQztRQUVqQyxlQUFVLEdBQWtCLElBQUksT0FBTyxFQUFRLENBQUM7UUFPdEQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FB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LENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRVMsZUFBZSxDQUFDLElBQVk7UUFDbEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyx5QkFBeUIsQ0FDekMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDNUYsQ0FBQzs7MEhBNUhRLDZCQUE2QixrSkFzQ2xCLHlCQUF5Qjs4R0F0Q3BDLDZCQUE2QjsyRkFBN0IsNkJBQTZCO2tCQUh6QyxTQUFTO21CQUFDO29CQUNQLFFBQVEsRUFBRSx3QkFBd0I7aUJBQ3JDOzswQkF1Q2dCLE1BQU07MkJBQUMseUJBQXlCOzRDQW5DekMsS0FBSztzQkFEUixLQUFLO2dCQWNGLFdBQVc7c0JBRGQsS0FBSztnQkF3RU4sU0FBUztzQkFEUixZQUFZO3VCQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RGlyZWN0aXZlLCBIb3N0TGlzdGVuZXIsIEluamVjdCwgSW5wdXQsIE9uRGVzdHJveSwgT25Jbml0fSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQge1RoZW1lUGFsZXR0ZX0gZnJvbSBcIkBhbmd1bGFyL21hdGVyaWFsL2NvcmVcIjtcclxuLy9cclxuaW1wb3J0IHtOZ3hNYXRUaW1lcGlja2VyRXZlbnRTZXJ2aWNlfSBmcm9tIFwiLi4vc2VydmljZXMvbmd4LW1hdC10aW1lcGlja2VyLWV2ZW50LnNlcnZpY2VcIjtcclxuaW1wb3J0IHtOZ3hNYXRUaW1lcGlja2VyTG9jYWxlU2VydmljZX0gZnJvbSBcIi4uL3NlcnZpY2VzL25neC1tYXQtdGltZXBpY2tlci1sb2NhbGUuc2VydmljZVwiO1xyXG5pbXBvcnQge05neE1hdFRpbWVwaWNrZXJTZXJ2aWNlfSBmcm9tIFwiLi4vc2VydmljZXMvbmd4LW1hdC10aW1lcGlja2VyLnNlcnZpY2VcIjtcclxuaW1wb3J0IHtOZ3hNYXRUaW1lcGlja2VyQWRhcHRlcn0gZnJvbSBcIi4uL3NlcnZpY2VzL25neC1tYXQtdGltZXBpY2tlci1hZGFwdGVyXCI7XHJcbi8vXHJcbmltcG9ydCB7Tmd4TWF0VGltZXBpY2tlclVuaXRzfSBmcm9tIFwiLi4vbW9kZWxzL25neC1tYXQtdGltZXBpY2tlci11bml0cy5lbnVtXCI7XHJcbmltcG9ydCB7Tmd4TWF0VGltZXBpY2tlckNsb2NrRmFjZX0gZnJvbSBcIi4uL21vZGVscy9uZ3gtbWF0LXRpbWVwaWNrZXItY2xvY2stZmFjZS5pbnRlcmZhY2VcIjtcclxuaW1wb3J0IHtOZ3hNYXRUaW1lcGlja2VyUGVyaW9kc30gZnJvbSBcIi4uL21vZGVscy9uZ3gtbWF0LXRpbWVwaWNrZXItcGVyaW9kcy5lbnVtXCI7XHJcbmltcG9ydCB7Tmd4TWF0VGltZXBpY2tlckNvbmZpZ30gZnJvbSBcIi4uL21vZGVscy9uZ3gtbWF0LXRpbWVwaWNrZXItY29uZmlnLmludGVyZmFjZVwiO1xyXG5pbXBvcnQge05HWF9NQVRfVElNRVBJQ0tFUl9DT05GSUd9IGZyb20gXCIuLi90b2tlbnMvbmd4LW1hdC10aW1lcGlja2VyLWNvbmZpZy50b2tlblwiO1xyXG4vL1xyXG5pbXBvcnQge09ic2VydmFibGUsIFN1YmplY3R9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7c2hhcmVSZXBsYXksIHRha2VVbnRpbH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiBcIltuZ3hNYXRUaW1lcGlja2VyQmFzZV1cIlxyXG59KVxyXG5leHBvcnQgY2xhc3MgTmd4TWF0VGltZXBpY2tlckJhc2VEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcblxyXG4gICAgQElucHV0KClcclxuICAgIHNldCBjb2xvcihuZXdWYWx1ZTogVGhlbWVQYWxldHRlKSB7XHJcbiAgICAgICAgdGhpcy5fY29sb3IgPSBuZXdWYWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY29sb3IoKTogVGhlbWVQYWxldHRlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fY29sb3I7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGRlZmF1bHRUaW1lKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RlZmF1bHRUaW1lO1xyXG4gICAgfVxyXG5cclxuICAgIEBJbnB1dCgpXHJcbiAgICBzZXQgZGVmYXVsdFRpbWUodGltZTogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5fZGVmYXVsdFRpbWUgPSB0aW1lO1xyXG4gICAgICAgIHRoaXMuX3NldERlZmF1bHRUaW1lKHRpbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0IF9sb2NhbGUoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fdGltZXBpY2tlckxvY2FsZVNydi5sb2NhbGU7XHJcbiAgICB9XHJcblxyXG4gICAgYWN0aXZlVGltZVVuaXQ6IE5neE1hdFRpbWVwaWNrZXJVbml0cyA9IE5neE1hdFRpbWVwaWNrZXJVbml0cy5IT1VSO1xyXG4gICAgc2VsZWN0ZWRIb3VyOiBPYnNlcnZhYmxlPE5neE1hdFRpbWVwaWNrZXJDbG9ja0ZhY2U+O1xyXG4gICAgc2VsZWN0ZWRNaW51dGU6IE9ic2VydmFibGU8Tmd4TWF0VGltZXBpY2tlckNsb2NrRmFjZT47XHJcbiAgICBzZWxlY3RlZFBlcmlvZDogT2JzZXJ2YWJsZTxOZ3hNYXRUaW1lcGlja2VyUGVyaW9kcz47XHJcbiAgICB0aW1lVW5pdDogdHlwZW9mIE5neE1hdFRpbWVwaWNrZXJVbml0cyA9IE5neE1hdFRpbWVwaWNrZXJVbml0cztcclxuXHJcbiAgICBwcm90ZWN0ZWQgX2NvbG9yOiBUaGVtZVBhbGV0dGUgPSBcInByaW1hcnlcIjtcclxuICAgIHByb3RlY3RlZCBfZGVmYXVsdFRpbWU6IHN0cmluZztcclxuICAgIHByb3RlY3RlZCBfc3Vic0N0cmwkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgX3RpbWVwaWNrZXJTcnY6IE5neE1hdFRpbWVwaWNrZXJTZXJ2aWNlLFxyXG4gICAgICAgICAgICAgICAgcHJvdGVjdGVkIF9ldmVudFNydjogTmd4TWF0VGltZXBpY2tlckV2ZW50U2VydmljZSxcclxuICAgICAgICAgICAgICAgIHByb3RlY3RlZCBfdGltZXBpY2tlckxvY2FsZVNydjogTmd4TWF0VGltZXBpY2tlckxvY2FsZVNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgICBASW5qZWN0KE5HWF9NQVRfVElNRVBJQ0tFUl9DT05GSUcpIHB1YmxpYyBkYXRhOiBOZ3hNYXRUaW1lcGlja2VyQ29uZmlnKSB7XHJcblxyXG4gICAgICAgIHRoaXMuY29sb3IgPSBkYXRhLmNvbG9yO1xyXG4gICAgICAgIHRoaXMuZGVmYXVsdFRpbWUgPSBkYXRhLmRlZmF1bHRUaW1lO1xyXG4gICAgfVxyXG5cclxuICAgIGNoYW5nZVBlcmlvZChwZXJpb2Q6IE5neE1hdFRpbWVwaWNrZXJQZXJpb2RzKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5fdGltZXBpY2tlclNydi5wZXJpb2QgPSBwZXJpb2Q7XHJcbiAgICAgICAgdGhpcy5fb25UaW1lQ2hhbmdlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hhbmdlVGltZVVuaXQodW5pdDogTmd4TWF0VGltZXBpY2tlclVuaXRzKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5hY3RpdmVUaW1lVW5pdCA9IHVuaXQ7XHJcbiAgICB9XHJcblxyXG4gICAgY2xvc2UoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5kYXRhLnRpbWVwaWNrZXJCYXNlUmVmLmNsb3NlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5fc3Vic0N0cmwkLm5leHQoKTtcclxuICAgICAgICB0aGlzLl9zdWJzQ3RybCQuY29tcGxldGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLl9kZWZpbmVUaW1lKCk7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZEhvdXIgPSB0aGlzLl90aW1lcGlja2VyU3J2LnNlbGVjdGVkSG91clxyXG4gICAgICAgICAgICAucGlwZShzaGFyZVJlcGxheSh7YnVmZmVyU2l6ZTogMSwgcmVmQ291bnQ6IHRydWV9KSk7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZE1pbnV0ZSA9IHRoaXMuX3RpbWVwaWNrZXJTcnYuc2VsZWN0ZWRNaW51dGVcclxuICAgICAgICAgICAgLnBpcGUoc2hhcmVSZXBsYXkoe2J1ZmZlclNpemU6IDEsIHJlZkNvdW50OiB0cnVlfSkpO1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWRQZXJpb2QgPSB0aGlzLl90aW1lcGlja2VyU3J2LnNlbGVjdGVkUGVyaW9kXHJcbiAgICAgICAgICAgIC5waXBlKHNoYXJlUmVwbGF5KHtidWZmZXJTaXplOiAxLCByZWZDb3VudDogdHJ1ZX0pKTtcclxuICAgICAgICB0aGlzLmRhdGEudGltZXBpY2tlckJhc2VSZWYudGltZVVwZGF0ZWQucGlwZSh0YWtlVW50aWwodGhpcy5fc3Vic0N0cmwkKSlcclxuICAgICAgICAgICAgLnN1YnNjcmliZSh0aGlzLl9zZXREZWZhdWx0VGltZS5iaW5kKHRoaXMpKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkhvdXJDaGFuZ2UoaG91cjogTmd4TWF0VGltZXBpY2tlckNsb2NrRmFjZSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX3RpbWVwaWNrZXJTcnYuaG91ciA9IGhvdXI7XHJcbiAgICAgICAgdGhpcy5fb25UaW1lQ2hhbmdlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgb25Ib3VyU2VsZWN0ZWQoaG91cjogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmRhdGEuaG91cnNPbmx5KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlVGltZVVuaXQoTmd4TWF0VGltZXBpY2tlclVuaXRzLk1JTlVURSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZGF0YS50aW1lcGlja2VyQmFzZVJlZi5ob3VyU2VsZWN0ZWQubmV4dChob3VyKTtcclxuICAgIH1cclxuXHJcbiAgICBASG9zdExpc3RlbmVyKFwia2V5ZG93blwiLCBbXCIkZXZlbnRcIl0pXHJcbiAgICBvbktleWRvd24oZTogYW55KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5fZXZlbnRTcnYuZGlzcGF0Y2hFdmVudChlKTtcclxuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uTWludXRlQ2hhbmdlKG1pbnV0ZTogTmd4TWF0VGltZXBpY2tlckNsb2NrRmFjZSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX3RpbWVwaWNrZXJTcnYubWludXRlID0gbWludXRlO1xyXG4gICAgICAgIHRoaXMuX29uVGltZUNoYW5nZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFRpbWUoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5kYXRhLnRpbWVwaWNrZXJCYXNlUmVmLnRpbWVTZXQuZW1pdCh0aGlzLl90aW1lcGlja2VyU3J2LmdldEZ1bGxUaW1lKHRoaXMuZGF0YS5mb3JtYXQpKTtcclxuICAgICAgICB0aGlzLmNsb3NlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIF9kZWZpbmVUaW1lKCk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IG1pblRpbWUgPSB0aGlzLmRhdGEubWluVGltZTtcclxuXHJcbiAgICAgICAgaWYgKG1pblRpbWUgJiYgKCF0aGlzLmRhdGEudGltZSAmJiAhdGhpcy5kYXRhLmRlZmF1bHRUaW1lKSkge1xyXG4gICAgICAgICAgICBjb25zdCB0aW1lID0gTmd4TWF0VGltZXBpY2tlckFkYXB0ZXIuZnJvbURhdGVUaW1lVG9TdHJpbmcobWluVGltZSwgdGhpcy5kYXRhLmZvcm1hdCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLl9zZXREZWZhdWx0VGltZSh0aW1lKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIF9vblRpbWVDaGFuZ2UoKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgdGltZSA9IE5neE1hdFRpbWVwaWNrZXJBZGFwdGVyLnRvTG9jYWxlVGltZVN0cmluZyh0aGlzLl90aW1lcGlja2VyU3J2LmdldEZ1bGxUaW1lKHRoaXMuZGF0YS5mb3JtYXQpLCB7XHJcbiAgICAgICAgICAgIGxvY2FsZTogdGhpcy5fbG9jYWxlLFxyXG4gICAgICAgICAgICBmb3JtYXQ6IHRoaXMuZGF0YS5mb3JtYXRcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5kYXRhLnRpbWVwaWNrZXJCYXNlUmVmLnRpbWVDaGFuZ2VkLmVtaXQodGltZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIF9zZXREZWZhdWx0VGltZSh0aW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLl90aW1lcGlja2VyU3J2LnNldERlZmF1bHRUaW1lSWZBdmFpbGFibGUoXHJcbiAgICAgICAgICAgIHRpbWUsIHRoaXMuZGF0YS5taW5UaW1lLCB0aGlzLmRhdGEubWF4VGltZSwgdGhpcy5kYXRhLmZvcm1hdCwgdGhpcy5kYXRhLm1pbnV0ZXNHYXApO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==